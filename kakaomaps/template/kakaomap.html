<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Kakao toy project</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" />
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script>
      // using jQuery
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == name + '=') {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
      }
      $(document).ready(function () {
        var csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
          beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader('X-CSRFToken', csrftoken);
            }
          },
        });
      });
    </script>
    <style>
      .map_wrap {
        width: 100%;
        position: relative;
      }
      .modes {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1;
      }
      #drawingMap,
      #map {
        height: 95vh;
      }
      #map {
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <div>
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-2">
              {% if map %}{% for m in map %}
              <button type="button" class="btn btn-primary btn-sm" onClick="addMap({{m}})">{{m.id}}</button>{% endfor %}{% endif %}
            </div>
            <div class="col-10">
              <div class="map_wrap">
                <div id="drawingMap"></div>
                <p class="modes">
                  <button type="button" class="btn btn-primary btn-sm" onclick="selectOverlay('POLYLINE')">선</button>
                  <button type="button" class="btn btn-primary btn-sm" onclick="selectOverlay('POLYGON')">다각형</button>
                  <button id="storage" type="button" class="btn btn-primary btn-sm" onclick="dataStorage()" disabled>저장하기</button>
                </p>
              </div>
            </div>
          </div>
          <script
            type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=05cdfbd2737d57318b066e52046677ec&libraries=services,clusterer,drawing"
          ></script>
          <script>
            // Drawing Manager로 도형을 그릴 지도 div
            var drawingMapContainer = document.getElementById('drawingMap'),
              drawingMap = {
                center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                level: 3, // 지도의 확대 레벨
              };

            // 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
            var drawingMap = new kakao.maps.Map(drawingMapContainer, drawingMap);

            var options = {
              // Drawing Manager를 생성할 때 사용할 옵션입니다
              map: drawingMap, // Drawing Manager로 그리기 요소를 그릴 map 객체입니다
              drawingMode: [
                // Drawing Manager로 제공할 그리기 요소 모드입니다
                kakao.maps.drawing.OverlayType.POLYLINE,
                kakao.maps.drawing.OverlayType.POLYGON,
              ],
              // 사용자에게 제공할 그리기 가이드 툴팁입니다
              // 사용자에게 도형을 그릴때, 드래그할때, 수정할때 가이드 툴팁을 표시하도록 설정합니다
              guideTooltip: ['draw', 'drag', 'edit'],

              polylineOptions: {
                // 선 옵션입니다
                draggable: true, // 그린 후 드래그가 가능하도록 설정합니다
                removable: true, // 그린 후 삭제 할 수 있도록 x 버튼이 표시됩니다
                editable: true, // 그린 후 수정할 수 있도록 설정합니다
                strokeColor: '#39f', // 선 색
                hintStrokeStyle: 'dash', // 그리중 마우스를 따라다니는 보조선의 선 스타일
                hintStrokeOpacity: 0.5, // 그리중 마우스를 따라다니는 보조선의 투명도
              },

              polygonOptions: {
                draggable: true,
                removable: true,
                editable: true,
                strokeColor: '#39f',
                fillColor: '#39f',
                fillOpacity: 0.5,
                hintStrokeStyle: 'dash',
                hintStrokeOpacity: 0.5,
              },
            };

            // 위에 작성한 옵션으로 Drawing Manager를 생성합니다
            var manager = new kakao.maps.drawing.DrawingManager(options),
              overlays = [],
              drawOverlays = [];

            // 지도에 그려진 도형이 있다면 모두 지웁니다
            function removeOverlays() {
              // 추가된 도형 삭제
              var len = overlays.length,
                i = 0;

              for (; i < len; i++) {
                overlays[i].setMap(null);
              }

              overlays = [];

              // 그려진 도형 삭제
              var len = drawOverlays.length,
                i = 0;

              for (; i < len; i++) {
                manager.remove(drawOverlays[i]);
              }

              drawOverlays = [];
            }

            // 버튼 클릭 시 호출되는 핸들러 입니다
            function selectOverlay(type) {
              removeOverlays();

              // 그리기 중이면 그리기를 취소합니다
              manager.cancel();

              // 클릭한 그리기 요소 타입을 선택합니다
              manager.select(kakao.maps.drawing.OverlayType[type]);
            }

            // 그리기가 끝날 때 저장하기 버튼을 활성화합니다
            manager.addListener('drawend', function (data) {
              var storageBtn = document.getElementById('storage');
              storageBtn.disabled = false;
              drawOverlays.push(data.target);
            });

            // 그리기를 취소할 경우 저장하기 버튼을 비활성화합니다
            manager.addListener('cancel', function (e) {
              var storageBtn = document.getElementById('storage');
              storageBtn.disabled = true;
            });

            // 그리기 요소를 삭제할 경우 저장하기 버튼을 비활성화합니다
            manager.addListener('remove', function (e) {
              var storageBtn = document.getElementById('storage');
              storageBtn.disabled = true;
            });

            // 그리기 요소를 선택할 경우 저장하기 버튼을 비활성화합니다
            manager.addListener('select', function (e) {
              var storageBtn = document.getElementById('storage');
              storageBtn.disabled = true;
            });

            // 그려진 객체 데이터를 DB에 저장하는 함수입니다
            function dataStorage() {
              var data = manager.getData();

              $.ajax({
                type: 'POST',
                data: { data },
                url: `{% url 'storage' %}`,
                success: function (res) {},
              });
            }

            // 저장한 Map 데이터를 불러오는 함수입니다
            function addMap(data) {
              if (data.type == 'polygon') {
                drawPolygon(data);
              } else {
                drawPolyline(data);
              }
            }

            // Drawing Manager에서 가져온 데이터 중 선을 아래 지도에 표시하는 함수입니다
            function drawPolyline(lines) {
              var path = pointsToPath(lines.points);
              var polyline = new kakao.maps.Polyline({
                map: drawingMap,
                path: path,
                strokeColor: style.strokeColor,
                strokeOpacity: style.strokeOpacity,
                strokeStyle: style.strokeStyle,
                strokeWeight: style.strokeWeight,
              });

              polyline.setMap(drawingMap);
              overlays.push(polyline);
            }

            // Drawing Manager에서 가져온 데이터 중 다각형을 아래 지도에 표시하는 함수입니다
            function drawPolygon(polygons) {
              var path = pointsToPath(polygons.points);
              var polygon = new kakao.maps.Polygon({
                map: drawingMap,
                path: path,
                strokeColor: polygons.strokeColor,
                strokeOpacity: polygons.strokeOpacity,
                strokeStyle: polygons.strokeStyle,
                strokeWeight: polygons.strokeWeight,
                fillColor: polygons.fillColor,
                fillOpacity: polygons.fillOpacity,
              });

              polygon.setMap(drawingMap);
              overlays.push(polygon);
            }

            // Drawing Manager에서 가져온 데이터 중
            // 선과 다각형의 꼭지점 정보를 kakao.maps.LatLng객체로 생성하고 배열로 반환하는 함수입니다
            function pointsToPath(points) {
              var len = points.length,
                path = [],
                i = 0;

              for (; i < len; i++) {
                // point[i][1] == y값, point[i][0] == x값
                var latlng = new kakao.maps.LatLng(points[i][1], points[i][0]);
                path.push(latlng);
              }

              return path;
            }
          </script>
        </div>
      </div>
    </div>
  </body>
</html>
